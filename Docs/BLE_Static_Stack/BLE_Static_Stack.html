<!-- HTML header for doxygen 1.8.10-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>Bluetooth LE Static Stack: Building an application separated from BlueNRG-LP stack</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="STcustom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ST-logo-small.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Bluetooth LE Static Stack
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Building an application separated from BlueNRG-LP stack </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This document describes how to build a Bluetooth LE demo application using the static Bluetooth LE stack approach. It is possible to build a project containing the BlueNRG-LP stack library with all (or part) of its APIs and build a second project that does not contains the stack and nevertheless it can use it. In this way the second project, containing only the application, can be programmed into the device without reprogramming the BlueNRG-LP stack. <b> This is valid as long as the Bluetooth stack does not have to be changed.</b> The document content is valid for both BlueNRG-LP devices. <br />
<br />
 Follow the list of key steps to be followed:</p>
<h1><a class="anchor" id="_1"></a>
Bluetooth LE static stack description</h1>
<p>In the partitioning illustrated in <b>Figure 1:Flash memory partitioning</b>, the Bluetooth LE stack is programmed in a section of the flash together with a simple reset manager. Normally this application only has the task to jump to the application code and call the service routines in the applicationâ€™s interrupt vector table once an interrupt occurs (necessary because interrupt vector table remapping is not supported in Cortex-M0). <br />
 This simple reset manager may be replaced by a more complex application, e.g. a bootloader</p>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="Figure_1.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 1: Flash memory partitioning </b>  </td></tr>
</table>
<p>The reset manager should not use any variable in RAM, hence the only RAM space used by the reset manager firmware is the one used by the Bluetooth LE library. Part of the RAM can be reserved for special variables shared between simple and main application, e.g. to perform a software activation of a bootloader. <b>Figure 2: RAM partitioning </b> shows the RAM statically allocated by the stack (blue area). The BlueNRG-LP stack also needs additional RAM that is provided by the application during stack initialization. This space is allocated by the application.</p>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="Figure_2.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 2: RAM partitioning </b>  </td></tr>
</table>
<h1><a class="anchor" id="_2"></a>
Building an application that uses the BlueNRG-LP Static Stack</h1>
<p>BLE_SensorDemo_with_Static_Stack is a demonstration application under Project\BLE_Examples directory. This application does not contain the Bluetooth library but uses the APIs provided by the library programmed inside the first area of the Flash.</p>
<p>In order to correctly configure a project to use the Bluetooth LE static library, the symbols of the library must be taken into account by the linker during the linking process. All the pointers to the functions that are exported by the library are accessible through a table in Flash (command table) or directly, using a library containing absolute symbols (e.g. libbluenrg_lp_static_stack.a). The pointers to the callbacks for events generated by the library are instead stored in a table in RAM (event table), so that the application can write its own pointers into this table.</p>
<p>The libbluenrg_lp_static_stack.a file is generated by the BLE_Static_Stack project, so that this file can be used by application's project during linking phase to resolve all the required symbols. The bluenrg_lp_stack_init_if.c file is used in order to automatically register all the application callbacks without taking care of explicitly register them when using the static stack library.</p>
<p>Two linker variables for the application's project need to be set to the proper values. MEMORY_FLASH_APP_OFFSET must be set to the start of the first available sector in Flash. MEMORY_RAM_APP_OFFSET must be set with an address that is equal to (or greater than) the offset of the first available RAM location. See BLE_SensorDemo_StaticStack project to know which RAM offset must be used by your application when using the Static Stack included insided the BlueNRG-LP DK. When using a customized recompiled version of the static Bluetooth LE library, the map file generated together with the Bluetooth LE static stack library indicates which is the first RAM location that is available to the application. E.g.: </p><ul>
<li>
If static stack binary uses flash space till address 0x1005a598, MEMORY_FLASH_APP_OFFSET=0x1A800 (i.e. 0x1005a598 - 0x10040000, rounded to the start of the sector) </li>
<li>
If static stack library uses RAM till address 0x20001428, MEMORY_RAM_APP_OFFSET=0x1428 (i.e. 0x20001428 - 0x20000000) </li>
</ul>
<h2><a class="anchor" id="_2_1"></a>
Build steps</h2>
<ul>
<li>
Remove libbluenrg_lp_stack.a and stack_user_cfg.c from project files.  </li>
<li>
Remove all the external modules and drivers, which have been included in static stack (their symbols are exported and can be used by application): <ul>
<li>
AES  </li>
<li>
BLECNTR  </li>
<li>
Cryptolib  </li>
<li>
NVM  </li>
<li>
PKA  </li>
<li>
RNG  </li>
<li>
GAP and GATT profiles  </li>
<li>
HAL_VTimer  </li>
</ul>
</li>
<li>
Include bluenrg_lp_stack_init_if.c and libbluenrg_lp_static_stack.a (or libbluenrg_lp_static_stack_basic.a for minimal stack) in your project (from Middlewares\ST\Bluetooth_LE\Library\static_stack). </li>
<li>
Define MEMORY_FLASH_APP_OFFSET for linker, depending on the Flash size occupied by the BlueNRG static stack image. E.g. if static stack image uses the Flash till address 0x1005a438, offset must be equal to 0x1A800, which is the offset of the first available Flash location aligned to the start of a page. </li>
<li>
Define MEMORY_RAM_APP_OFFSET for linker, in order to allocate variables in free RAM space, where no other variables have been allocated by the static stack library. See MEMORY_RAM_APP_OFFSET used inside BLE_SensorDemo_Static_Stack project to know which RAM offset must be used by your application when using the Static Stack binary included insided the BlueNRG-LP DK. </li>
<li>
Use the same modular configuration used for static stack (e.g. BLE_STACK_FULL_CONF if static stack has been built with BLE_STACK_FULL_CONF, use BLE_STACK_BASIC_CONF if static stack has been built with BLE_STACK_BASIC_CONF).<br />
 </li>
</ul>
<p>Note: Do not define CONFIG_NUM_MAX_LINKS (maximum number of link layer state machines) with a value greater than the one used to build the static stack binary. The static stack binary has been generated with the default value of CONFIG_NUM_MAX_LINKS, which is 8. If more state machines are needed (e.g. more connections), the static stack need to be rebuilt with the desired value of CONFIG_NUM_MAX_LINKS.</p>
<h2><a class="anchor" id="_2_2"></a>
Run steps</h2>
<ul>
<li>Load the Static Stack image based on the device type and the OTA update scenario (BLE_StaticStack.hex or BLE_StaticStack_OTA_BTL_ResetManager.hex). </li>
<li>Load the application built to support the static stack.</li>
</ul>
<h1><a class="anchor" id="_3"></a>
Support to OTA firmware update</h1>
<p>It is possible to upgrade only the application firmware over-the-air if the application has the support for the OTA Service Manager. It is also required that the Static Stack is built with a Reset Manager which is able to deal with a "dual firmware" approach. The application area is divided in two sections: the lower part and the higher part.</p>
<p>The example projects includes configurations to support firmware upgrade over-the-air. When using this configuration, the application must link a specific library (libbluenrg_lp_static_stack_w_resetmanager.a), which has been created including the OTA update reset manager.</p>
<p>The difference with respect to the basic configuration are: </p><ul>
<li>Linker macro RESET_MANAGER_SIZE is used instead of MEMORY_FLASH_APP_OFFSET. </li>
<li>Linker macro CONFIG_OTA_LOWER or CONFIG_OTA_HIGHER must be used to distinguish between "lower app" and "higher app" builds. Together with MEMORY_FLASH_APP_OFFSET it is necessary for the the linker in order to place the code in the the correct Flash area. </li>
<li>C preprocessor macro RESET_MANAGER_SIZE has to be defined (needed by the OTA update library).</li>
</ul>
<h1><a class="anchor" id="_4"></a>
Building BlueNRG-LP Static Stack project</h1>
<p>The BlueNRG-LP static stack is provided inside the Bluenrg_LP DK in binary format (BLE_StaticStack.hex and BLE_StaticStack_OTA_BTL_ResetManager.hex), ready to be programmed into the device. Usually there is no need to build it again. If you do not want to modify it, you can skip this section.</p>
<p>BLE_StaticStack project in Projects\BLE_Examples folder can be used to build a firmware that contains only the Bluetooth stack library and a reset manager. The projects for IAR Embedded Workbench for ARM, KEIL MDK-ARM and WiSE Studio are provided. Compared to a normal application using BlueNRG stack library, these projects contain two additional C files: </p><ul>
<li>
bluenrg_cmd_if.c: it defines an array that contains all the stack APIs (<em>command table</em>), used to prevent the linker from removing functions. </li>
<li>
<p class="startli">bluenrg_ev_if.c: an array is defined, which is used to store the pointers to the stack callbacks (<em>event table</em>). These pointers must be provided by the application.</p>
<p class="endli">After the firmware is built, an external program generates a library, libbluenrg_lp_static_stack.a, containing the symbol table of the stack's function addresses. The pointers to the callback functions has to be stored in an array allocated in RAM (ev_call_table), whose symbol is provided in libbluenrg_lp_static_stack.a. Using a library containing the addresses of all the symbols allows to directly call stack's functions without accessing them through the command table (faster access and less code). <br />
 Two macros need to be changed in case the linking process fails because space is not enough, or if the space reserved for the stack becomes lower: RESET_MANAGER_SIZE and MEMORY_FLASH_APP_SIZE. <br />
 The preprocessor macro RESET_MANAGER_SIZE must be set to the offset of the first flash address of the main application. MEMORY_FLASH_APP_SIZE linker variable is used to avoid that the flash occupancy becomes higher than expected. If set it to a given value, the linker returns error if the size of the flash needed by the application is higher than the specified value. <br />
 E.g. if after the building process the first available address in Flash (rounded to the beginning of the next sector) is 0x10054000, RESET_MANAGER_SIZE can be set to 0x14000 (i.e. 0x10054000 - 0x10040000). MEMORY_FLASH_APP_SIZE must set to 0x14000 to be sure that the building process gives error if the size of the firmware exceeds this limit. </p><ul>
<li><em> After the firmware has been built, the map file must be analyzed to take note of the last address in RAM used by the stack (except for the CSTACK block). This is important to build a working application.</em> </li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="_4_1"></a>
Prerequisites</h2>
<p>Install GNU ARM Embedded Toolchain and add the binary folder in the system PATH. The utility create_sym_lib.exe in BlueNRG-LP SDK Utility folder needs the following utilities: </p><ul>
<li>arm-none-eabi-readelf </li>
<li>arm-none-eabi-gcc </li>
<li>arm-none-eabi-ar</li>
</ul>
<p>Open the Windows Command Prompt and try to invoke those commands to check if they are correctly installed. </p>
<h2><a class="anchor" id="_4_2"></a>
Build steps</h2>
<ul>
<li>Build "Bluetooth LE Static Stack" project. If necessary, change MEMORY_FLASH_APP_SIZE (for linker) to increase (or possibly reduce) the flash reserved for the BlueNRG-LP Stack. </li>
<li>If MEMORY_FLASH_APP_SIZE has been changed, change also RESET_MANAGER_SIZE (for C preprocessor). This macro points to the base of the flash where the application resides and it should be equal to MEMORY_FLASH_APP_SIZE + MEMORY_FLASH_APP_OFFSET. </li>
<li>Use create_sym_lib.exe utility to generate the required library with symbols to be referenced by the application. This is done as a post-build task in Bluetooth LE Static Stack project. </li>
<li>Take a note of the first available address in RAM (excluding CSTACK) from map file. (e.g. 0x20000800). It has to be used when defining MEMORY_RAM_APP_OFFSET inside application project. </li>
</ul>
<h1><a class="anchor" id="_5"></a>
Using a bootloader</h1>
<ul>
<li>When the application needs a second level bootloader (1) , the best solution is to place the bootloader at the beginning of the Flash. In this case the stack library must be allocated starting at a given offset inside the Flash. The offset can be provided to the linker through the MEMORY_FLASH_APP_OFFSET variable. </li>
<li>E.g., if the bootloader occupies the first two sectors of the Flash, MEMORY_FLASH_APP_OFFSET must be set to 0x1000.</li>
</ul>
<ul>
<li>(1) First level bootloader is in ROM and accessible through UART interface.</li>
</ul>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="Figure_3.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 3: Stack allocation in Flash with offset </b>  </td></tr>
</table>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.10-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Copyright &copy; 2022 by STMicrolectronics. All rights reserved.<br>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.10
</small></address>
</body>
</html>
