<!-- HTML header for doxygen 1.8.10-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>Bluetooth LE stack migration guidelines from v2.x to v3.x: Bluetooth LE stack v3.0 to v3.1x general migration guideline for user application</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="STcustom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ST-logo-small.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Bluetooth LE stack migration guidelines from v2.x to v3.x
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">Introduction</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Bluetooth LE stack v3.0 to v3.1x general migration guideline for user application </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li>(1) On user application main file update ModulesInit() for adding new standalone external modules (BLE controller driver and AES, RNG, PKA manager drivers):<ul>
<li>BLECNTR_InitGlobal();</li>
<li>PKAMGR_Init();</li>
<li>RNGMGR_Init();</li>
<li>AESMGR_Init();</li>
</ul>
</li>
<li>(2) On user application IDE project, perform the following changes:<ul>
<li>Add the new standalone external modules header files paths (with proper prefix based on the IDE toolchain rules):<ul>
<li>Middlewares\ST\PKAMGR\Inc</li>
<li>Middlewares\ST\RNGMGR\Inc</li>
<li>Middlewares\ST\AESMGR\Inc</li>
<li>Middlewares\ST\BLECNTR\Inc</li>
</ul>
</li>
<li>Add the new standalone external modules sources files on IDE project (dedicated file is available for each supported device where needed):<ul>
<li>Middlewares\ST\PKAMGR\Src\[pka_manager.c, pka_manager_bluenrg_lp.c, pka_manager_bluenrg_lps.c]</li>
<li>Middlewares\ST\RNGMGR\Src\[rng_manager,c, rng_manager_bluenrg_lp.c]</li>
<li>Middlewares\ST\AESMGR\Src\[aes_manager,c, aes_manager_bluenrg_lp.c]</li>
<li>Middlewares\ST\BLECNTR\Src\[ble_controller.c, ble_controller_bluenrg_lp.c]</li>
</ul>
</li>
<li>Replace Peripheral Drivers with new set of device drivers with prefix <b>rf_driver</b> available on SDK installation path, Drivers folder</li>
<li>On user code, replace any include to previous Peripheral Drivers header files with the new one with prefix rf_driver</li>
</ul>
</li>
<li>(3) On user application Bluetooth LE configuration file user_config.h, perform the following changes:<ul>
<li>Properly define and add NUM_SYNC_SLOTS_CONF, MAX_NUM_CTE_ANTENNA_IDS, MAX_NUM_CTE_IQ_SAMPLES to DYNAMIC_MEMORY_SIZE (on BlueNRG-LP, MAX_NUM_CTE_ANTENNA_IDS, MAX_NUM_CTE_IQ_SAMPLES must be set to 0 since Direction Finding features(AoA, AoD) are not supported on BlueNRG-LP device)</li>
<li>Remove .HotAnaConfigTable = hot_table_radio_config line from BLE_STACK_INIT_PARAMETERS define</li>
<li>Add the following 6 new lines to BLE_STACK_INIT_PARAMETERS define<ul>
<li>.NumOfSyncSlots = NUM_SYNC_SLOTS_CONF, \</li>
<li>.CTE_MaxNumAntennaIDs = MAX_NUM_CTE_ANTENNA_IDS, \</li>
<li>.CTE_MaxNumIQSamples = MAX_NUM_CTE_IQ_SAMPLES, \</li>
<li>.isr0_fifo_size = ISR0_FIFO_SIZE, \</li>
<li>.isr1_fifo_size = ISR1_FIFO_SIZE, \</li>
<li>.user_fifo_size = USER_FIFO_SIZE \</li>
</ul>
</li>
</ul>
</li>
<li>NOTEs:<ul>
<li>NUM_SYNC_SLOTS_CONF: maximum number of slots for synchronizing, valid only when Periodic Advertising and Synchronizing Feature is enabled.</li>
<li>MAX_NUM_CTE_ANTENNA_IDS: maximum number of Antenna IDs in the antenna pattern used in CTE connection oriented mode (valid only if AoA/AoD features are supported)</li>
<li>MAX_NUM_CTE_IQ_SAMPLES: maximum number of IQ samples in the buffer used in CTE connection oriented mode.(valid only if AoA/AoD features are supported)</li>
<li>ISR0_FIFO_SIZE: Size of the internal FIFO used for critical controller events produced by the ISR (e.g. rx data packets). 256 is the typical defualt value.</li>
<li>ISR1_FIFO_SIZE: Size of the internal FIFO used for non-critical controller events produced by the ISR (e.g. advertising or IQ sampling reports).768 is the typical defualt value.</li>
<li>USER_FIFO_SIZE: Size of the internal FIFO used for controller and host events produced outside the ISR. 1024 is the typical defualt value.</li>
</ul>
</li>
<li>(4) If addressing a BlueNRG-LPS device, on user IDE project, select the related target device (BlueNRG-332xy), replace STEVAL_IDB011V1 with STEVAL_IDB012V1 preprocessor option, CONFIG_DEVICE_BLUENRG_LP with CONFIG_DEVICE_BLUENRG_LPS preprocessor option and refer related BlueNRG-LPS linker file.</li>
<li>(5) ST Bluetooth LE stack v3.1a or later provides a new modular configuration option (CONNECTION_ENABLED) for allowing to enable/disable the connection capability option. When CONNECTION_ENABLED = 0 (connection capability is not supported), user shall perform the following modifications on his user application:<ul>
<li>on user IDE project, BLE_STACK_CUSTOM_CONF preprocessor option is defined and related custom_ble_stack_config.h header file with CONNECTION_ENABLED = 0 is used.</li>
<li>on user IDE project, the gap_profile.c, gatt_profile.c are excluded from the application building.</li>
<li>the aci_gatt_srv_init() is not anymore called (since no characteristics are added).</li>
<li>the aci_gap_init(), role parameter is defined as GAP_BROADCASTER_ROLE (only broadcaster) or GAP_BROADCASTER_ROLE|GAP_OBSERVER_ROLE (only broadcaster, observer) depending on CONTROLLER_MASTER_ENABLED value (0/1).</li>
<li>The Gap_profile_set_dev_name() is not anymore called</li>
<li>the aci_gap_set_advertising_configuration(),Discoverable_Mode parameter is defined as GAP_MODE_BROADCAST.</li>
<li>the Advertising_Data paramenter on aci_gap_set_advertising_data() does not set the general discoverable mode flag, since it is not supported on broadcaster mode.</li>
<li>the Middlewares\ST\Bluetooth_LE\Src\stack_cns_api_stubs.c file is included on user IDE project. </li>
</ul>
</li>
</ul>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.10-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Copyright &copy; 2022 by STMicrolectronics. All rights reserved.<br>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.10
</small></address>
</body>
</html>
