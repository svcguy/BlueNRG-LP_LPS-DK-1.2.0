<!-- HTML header for doxygen 1.8.10-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>BlueNRG-LP/BlueNRG-LPS DTM SPI mode: SPI protocol specification</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="STcustom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ST-logo-small.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BlueNRG-LP/BlueNRG-LPS DTM SPI mode
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">SPI protocol specification </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This document outlines the main specification for the SPI protocol to be used in the BlueNRG-LP/BlueNRG-LPS network coprocessor configuration. <br />
 The document content is valid for both BlueNRG-LP/BlueNRG-LPS devices. <br />
 The specification aims at achieving the following targets: </p><ul>
<li>
Very similar to BlueNRG-1, BlueNRG-2 protocol </li>
<li>
Power efficient </li>
<li>
Code efficient </li>
<li>
Fast data transfer </li>
</ul>
<h1><a class="anchor" id="U1"></a>
BlueNRG-LP/BlueNRG-LPS Kit  SPI protocol HW, SW configuration</h1>
<ul>
<li>In order to use the BlueNRG GUI in SPI mode, with the BlueNRG-LP/BlueNRG-LPS kit platform modified for the standalone network coprocessor configuration, the following steps must be followed: <ul>
<li>
Update the BlueNRG-LP/BlueNRG-LPS firmware to the latest version of DTM - SPI mode (DTM_SPI.hex available on BlueNRG-LP/BlueNRG-LPS, STSW-BNRGLP-DK SW package folders: Firmware\BLE_Examples\DTM\{STEVAL-IDB011V1|STEVAL-IDB012V1}) by using the "Drag-and-Drop" upgrade capability or the RF-Flasher PC utility. </li>
<li>
Open the latest available BlueNRG GUI PC application</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="U2"></a>
SPI protocol hardware details</h1>
<ul>
<li>The SPI port requires five pins: <ul>
<li>
SPI CLK </li>
<li>
SPI MOSI </li>
<li>
SPI MISO </li>
<li>
SPI CS </li>
<li>
SPI IRQ </li>
</ul>
</li>
</ul>
<ul>
<li>The maximum SPI baud rate supported is 6 MHz. The timing diagram adopted is CPOL 1 and CPHA 1, which means data are captured on the SPI clock's rising edge and data is output on a rising edge. The SPI CS acts also as wake up pin for the BlueNRG-LP/BlueNRG-LPS, so that if the SPI CS pin is low (external uC select the BlueNRG-LP/BlueNRG-LPS for communication) the BlueNRG-LP/BlueNRG-LPS is woken up if it was asleep.The BlueNRG-LP notifies event pending to the external uC through the SPI IRQ pin. If the SPI IRQ pin is high, the BlueNRG-LP/BlueNRG-LPS has at least an event for the external uC.</li>
</ul>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="Table_1.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Table 1: BlueNRG-LP SPI lines </b>  </td></tr>
</table>
<ul>
<li>NOTE: BlueNRG-LPS SPI lines: <ul>
<li>
SPI MOSI: PA11 </li>
<li>
SPI MISO: PA8 </li>
<li>
SPI CLOCK: PA3 (on current STEVAL-IDB012V1 alpha kit (JP3, pin1): to be remapped to PB3 on official kit) </li>
<li>
SPI CS: PA9 </li>
<li>
SPI IRQ: PA10 </li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="U3"></a>
SPI communication protocol</h1>
<ul>
<li>To communicate with the BlueNRG-LP/BlueNRG-LPS, the data on the SPI bus must be formatted as described in this section. An SPI transaction is defined from a rising edge of the SPI CS signal to the next rising edge of the SPI CS signal. Each SPI transaction must contain only one data frame. Each data frame should contain at least 5 bytes of header, and may have from 0 to N bytes of data.</li>
</ul>
<h2><a class="anchor" id="U31"></a>
Generic transaction</h2>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="Figure_1.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 1: Generic SPI transaction </b>  </td></tr>
</table>
<ul>
<li>Figure 1 shows a generic SPI transaction, the list of steps is as follow: <ol>
<li>
The external uC lowers the SPI CS signal to start the communication </li>
<li>
The BlueNRG-LP/BlueNRG-LPS raises the SPI IRQ signal to indicate that it is ready for the communication. The time t1 change according to the state of the BlueNRG-LP/BlueNRG-LPS. This time t1 can include wake up of the BlueNRG-LP/BlueNRG-LPS and preparation of the header part of the frame. </li>
<li>
The external uC must wait for the SPI IRQ signal to become high and then start to transfer the five bytes of the header that include the control field with the intended operation.In addition, the external uC read five bytes from the BlueNRG-LP/BlueNRG-LPS, which includes information about the actual size of the read buffer and of the write buffer. </li>
<li>
The external uC, after checking the 5 bytes of header, will perform data transaction. </li>
<li>
The BlueNRG-LP/BlueNRG-LPS will lower SPI IRQ signal after the five bytes header are transferred. </li>
<li>
The external uC waits the SPI IRQ is low before raise the SPI CS signal to mark the end of the communication.</li>
</ol>
</li>
<li>Some important notes are: <ul>
<li>
Setting the SPI CS signal low will wake up BlueNRG-LP/BlueNRG-LPS if the device is asleep. </li>
<li>
If the SPI IRQ signal is low before setting the SPI CS signal low, this means the BlueNRG-LP/BlueNRG-LPS has no data events for the external uC, so the read buffer size is zero (RBUF=0). </li>
<li>
The time t1 is the time between wake-up (point a in Figure 1) and the BlueNRG-LP/BlueNRG-LPS being ready to perform the SPI transaction (point b in Figure 1). The time t1 ranges is from minimal value (the BlueNRG-LP/BlueNRG-LPS already awake when the SPI CS is asserted), to a maximum value that involves wake-up sequence and software boot. </li>
<li>
Even if there are events pending after the completion of the transaction, the SPI IRQ signal will go low to allow the BlueNRG-LP/BlueNRG-LPS updating the five bytes header an rearming the SPI for next transaction (after this delay the SPI IRQ signal will go high again if events are pending). </li>
<li>
The SPI CS signal marks the begin and end of the transaction </li>
<li>
The SPI CS high marks the end of the transaction and must be set to high only when IRQ line is low. </li>
<li>
The gap between the header and the data is not mandatory, but it is normally required by the external uC to process the header and check if there is enough space in the buffers to perform the wanted transaction. </li>
<li>
When the SPI IRQ signal is high, the five bytes header are locked and cannot be modified by BlueNRG-LP/BlueNRG-LPS firmware. </li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="U32"></a>
Header</h2>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="Figure_2.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 2: SPI header format </b>  </td></tr>
</table>
<ul>
<li>The header of the external uC (the SPI master) is on the MOSI line, which is composed by one control byte (CTRL) and four bytes 0x00. CTRL field can have only the value of 0x0A (SPI write) or 0x0B (SPI read). The BlueNRG-LP/BlueNRG-LPS returns the header on the MISO line at the same time. When the BlueNRG-LP/BlueNRG-LPS asserts the SPI IRQ signal, it is ready. Otherwise, the BlueNRG-LP/BlueNRG-LPS is still not initialized. External uC must wait for the IRQ line to become high and perform a five bytes transaction. The 5 bytes in the MISO line gives one byte of starting frame, two bytes with the size of the write buffer (WBUF) and two bytes with the size of the read buffer (RBUF). The endianness for WBUF and RBUF is LSB first. The value in WBUF means how many bytes the master can write to the BlueNRG-LP/BlueNRG-LPS. The value in RBUF means how many bytes in the BlueNRG-LP/BlueNRG-LPS are waiting to be read by the external uC.</li>
</ul>
<h2><a class="anchor" id="U33"></a>
Read transaction</h2>
<ul>
<li>A read transaction is performed when the BlueNRG-LP/BlueNRG-LPS raises the SPI IRQ line before the SPI CS signal is lowered by the external uC.</li>
</ul>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="Figure_3.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 3: SPI Read transaction </b>  </td></tr>
</table>
<ul>
<li>In this case, the SPI IRQ signal is high indicating the BlueNRG-LP/BlueNRG-LPS is awake and ready to perform the SPI transaction, after a hardware dependent setup time t2, typical value is 1.5 us. The transaction will be performed as follow: <ol>
<li>
An event has been generated by the BlueNRG-LP/BlueNRG-LPS (point a in Figure 3) </li>
<li>
The external uC lower the SPI CS signal to initiate a transaction (point b in Figure 3) </li>
<li>
Since the SPI IRQ signal is high, the external uC initiate a data transfer after t2. The external uC will transfer five bytes as follow [0x0B, XX, XX, XX, XX]. The WBUF and RBUF sizes are read from the SPI MISO signal. </li>
<li>
The external uC will perform the read data transaction for RBUF bytes. (Note: if RBUF is 0, this is an unexpected condition since the BlueNRG-LP/BlueNRG-LPS is indicating that data is available, in any case the transaction needs to be completed by reading no bytes). </li>
<li>
The BlueNRG-LP/BlueNRG-LPS will lower SPI IRQ signal after the five bytes header are transferred. </li>
<li>
The external uC will raise the SPI CS signal to mark the end of the transaction. </li>
</ol>
</li>
</ul>
<h2><a class="anchor" id="U34"></a>
Write transaction</h2>
<ul>
<li>A write transaction is performed by the external uC to send a command to the BlueNRG-LP/BlueNRG-LPS. The BlueNRG-LP/BlueNRG-LPS can be awake or sleeping when the SPI CS signal is lowered by the external uC. The assertion of the SPI CS signal will wakeup the BlueNRG-LP/BlueNRG-LPS, if asleep.</li>
</ul>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="Figure_4.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 4: SPI Write transaction </b>  </td></tr>
</table>
<ul>
<li>The transaction will be performed as follow: <ol>
<li>
The external uC lower the SPI CS signal to initiate a transaction. </li>
<li>
The BlueNRG-LP/BlueNRG-LPS raises the SPI IRQ signal to indicate that is ready with t1 &gt;= 0. </li>
<li>
The external uC waits for SPI IRQ signal to become high and start a transfer of five bytes sending the code of the intended operation and reading the read buffer and write buffer size. The external uC will transfer five bytes as follow [0x0A, XX, XX, XX, XX]. The WBUF and RBUF values are sampled in the SPI MISO signal. </li>
<li>
The BlueNRG-LP/BlueNRG-LPS will lower the SPI IRQ after the five bytes header are transferred. </li>
<li>
The external uC checks whether the WBUF allow sending the command. If yes, it will perform the data transaction, otherwise the external uC must waits. </li>
<li>
The external uC will wait for the SPI IRQ signal to be low before close the communication. </li>
<li>
The external uC will raise the SPI CS to mark the end of the transaction. </li>
</ol>
</li>
</ul>
<h2><a class="anchor" id="U35"></a>
Error transaction</h2>
<ul>
<li>This section list the BlueNRG-LP/BlueNRG-LPS firmware behavior when some error transactions are performed: <ul>
<li>
Incomplete header transaction (0 to 4): the BlueNRG-LP/BlueNRG-LPS ignores the transaction. </li>
<li>
The external uC does not wait for the SPI IRQ signal low before raising the SPI CS signal: the BlueNRG-LP/BlueNRG-LPS will low the SPI IRQ signal when the SPI CS signal is high. </li>
<li>
The external uC does not wait for the SPI IRQ signal high before starting SPI clock: the result is acquisition of corrupted data both master and slave side. </li>
<li>
Incomplete read transaction: the master loses the event. </li>
<li>
Incomplete write transaction: the BlueNRG-LP/BlueNRG-LPS will store the bytes written by the external uC. During next write operation the BlueNRG-LP/BlueNRG-LPS will get the new bytes trying to get a complete frame according Bluetooth protocol. </li>
<li>
<p class="startli">Two commands in a row without reading event for command: the BlueNRG-LP/BlueNRG-LPS will parse the two commands and then it will generate the corresponding events.</p>
<p class="endli"></p>
</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="U36"></a>
SPI state machine</h2>
<ul>
<li>Here after the description of the BlueNRG-LP/BlueNRG-LPS SPI state machine.</li>
</ul>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="Table_2.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Table 2: BlueNRG-LP/BlueNRG-LPS SPI state machine states </b>  </td></tr>
</table>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="Figure_5.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 5: SPI protocol state machine </b>  </td></tr>
</table>
<h2><a class="anchor" id="U37"></a>
External uC behavior</h2>
<ul>
<li>The external uC must act as follows according to the information from the BlueNRG-LP/BlueNRG-LPS: <ul>
<li>
SPI IRQ signal </li>
<li>
information from header frame WBUF and RBUF. </li>
</ul>
</li>
</ul>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="Table_3.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Table 3: BlueNRG-LP/BlueNRG-LPS SPI inputs </b>  </td></tr>
</table>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="Figure_6.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 6: Expected uC SPI protocol state machine </b>  </td></tr>
</table>
<p><br />
 </p>
<h2><a class="anchor" id="U38"></a>
Waveform acquisition</h2>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="Figure_7.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 7: HCI_READ_LOCAL_VERSION_INFORMATION SPI waveform </b>  </td></tr>
</table>
<p><br />
 </p><table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="Figure_8.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 8: HCI_READ_LOCAL_VERSION_INFORMATION SPI waveform zoom </b>  </td></tr>
</table>
<p><br />
 </p><table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="Figure_9.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 9: HCI_COMMAND_COMPLETE_EVENT SPI waveform </b>  </td></tr>
</table>
<p><br />
 </p>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.10-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Copyright &copy; 2022 by STMicrolectronics. All rights reserved.<br>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.10
</small></address>
</body>
</html>
