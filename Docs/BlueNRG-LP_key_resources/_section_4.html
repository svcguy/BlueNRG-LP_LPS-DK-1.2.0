<!-- HTML header for doxygen 1.8.10-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>BlueNRG-LP/BlueNRG-LPS Development kit: 4) Design &amp; Bringing Up custom BlueNRG-LP/BlueNRG-LPS PCB</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="STcustom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ST-logo-small.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BlueNRG-LP/BlueNRG-LPS Development kit
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">4) Design &amp; Bringing Up custom BlueNRG-LP/BlueNRG-LPS PCB </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="S4"></a>
Design custom PCB</h1>
<ul>
<li>The RF performance and the critical maximum peak voltage, spurious and harmonic emission, receiver matching strongly depend on the PCB layout as well as the selection of the matching network components. </li>
<li>For optimal performance, it is recommended the use of the PCB layout design hints described on the <a href="https://www.st.com/resource/en/application_note/dm00718453-pcb-design-guidelines-for-the-bluenrglp-device-stmicroelectronics.pdf">PCB design guidelines for the BlueNRG-LP, BlueNRG-LPS device Application Note (AN5526)</a> </li>
<li>Further, it is strongly suggested to use the BOM defined in the reference design, which guarantee, with a good PCB design, the correct RF performances. </li>
<li>Refer to the BlueNRG-LP platforms schematics available on <a href="https://www.st.com/en/product/BlueNRG-LP">BlueNRG-LP web page</a> </li>
<li>Refer to the BlueNRG-LPS platforms schematics available on <a href="https://www.st.com/en/product/BlueNRG-LPS">BlueNRG-LPS web page</a> </li>
<li>Refer to the <a href="https://www.st.com/en/product/BlueNRG-LP"><b>BlueNRG-LP datasheet (DS13282)</b></a> for the available I/O pins and the peripherals I/O mapping. </li>
<li>Refer to the <a href="https://www.st.com/en/product/BlueNRG-LPS"><b>BlueNRG-LPS datasheet (DS13819)</b></a> for the available I/O pins and the peripherals I/O mapping.</li>
</ul>
<h1><a class="anchor" id="S4_1"></a>
Test custom PCB</h1>
<ul>
<li>In order to finalize customer PCB design with BlueNRG-LP/BlueNRG-LPS devices, some reference <a class="anchor" id="bringing_up"></a>tests must be performed.</li>
</ul>
<ul>
<li>It is recommended to make available a set of test points in order to measure the performance of the device on the customer PCB. Depending on customer PCB constraints, it may not always be possible to add all test points, in which case some tests cannot be performed. </li>
<li>Refer to the <a href="https://www.st.com/resource/en/application_note/dm00710278-bringing-up-the-bluenrglp-device-stmicroelectronics.pdf">Bringing up the BlueNRG-LP, BlueNRG-LPS devices Application Note (AN5503)</a> and <a href="https://www.st.com/resource/en/application_note/dm00718453-pcb-design-guidelines-for-the-bluenrglp-device-stmicroelectronics.pdf">PCB design guidelines for the BlueNRG-LP, BlueNRG-LPS device Application Note (AN5526)</a>for detailed information. </li>
<li>User is requested to use some specific demonstration applications (DTM, demo application going on sleep mode) in order to properly configure the custom PCB for each specific bringing up test. Refer to next section about general guidelines about how to configure a test or demonstration application on a custom PCB.</li>
</ul>
<h2><a class="anchor" id="S4_1_1"></a>
How to configure a test or demonstration application on a custom PCB?</h2>
<ul>
<li>In order to properly configure a test application or demonstration application on a custom PCB, some basic application configuration parameters must be defined, based on selected custom PCB layout: <ul>
<li>
Low speed crystal source: external 32 kHz oscillator or internal RO </li>
<li>
SMPS configuration: enabled (with 10 uH, 2.2 uH, 1.5 uH) or disabled </li>
<li>
HSE capacitor value </li>
</ul>
</li>
</ul>
<ul>
<li>The following table provide the basic/mandatory preprocessor options to be configured, based on custom PCB:</li>
</ul>
<table  border="1">
<tr>
<th>Application Configuration Options </th><th>Preprocessor Option &amp; Value </th><th>Note  </th></tr>
<tr>
<td><b> Low speed crystal source </b></td><td>CONFIG_HW_LS_XTAL </td><td>PCB low speed crystal = external 32 kHz oscillator </td></tr>
<tr>
<td><b> Low speed crystal source </b></td><td>CONFIG_HW_LS_RO </td><td>PCB low speed crystal = internal RO </td></tr>
<tr>
<td><b> SMPS configuration </b></td><td>CONFIG_HW_SMPS_10uH </td><td>PCB SMPS inductor: SMPS enabled with 10 uH </td></tr>
<tr>
<td><b> SMPS configuration </b></td><td>CONFIG_HW_SMPS_2_2uH </td><td>PCB SMPS inductor: SMPS enabled with 2.2 uH </td></tr>
<tr>
<td><b> SMPS configuration </b></td><td>CONFIG_HW_SMPS_1_5uH </td><td>PCB SMPS inductor: SMPS enabled with 1.5 uH </td></tr>
<tr>
<td><b> SMPS configuration </b></td><td>CONFIG_HW_SMPS_NONE </td><td>PCB SMPS inductor disabled </td></tr>
<tr>
<td><b> HSE capacitor configuration </b></td><td>CONFIG_HW_HSE_TUNE = "value" </td><td>[0-63] as values range </td></tr>
</table>
<ul>
<li>NOTEs: <ul>
<li>
Refer to <a href="https://www.st.com/resource/en/programming_manual/dm00698052-bluetooth-le-stack-v3x-programming-guidelines-stmicroelectronics.pdf">Bluetooth LE Stack v3.x Library programming guidelines (PM0269)</a>, BlueNRG-LP, BlueNRG-LPS application configuration section for a detailed and complete list of available application configuration options and related values. </li>
<li>
Bluetooth LE Stack Library v3.x allows to optimize Bluetooth LE stack memory footprints based on user application scenario. User can select the Bluetooth LE stack v3.x modular configuration through the BLE_STACK_*_CONF preprocessor option which allows to enable/disable Controller Privacy, enable/disable LE secure Connections, enable/disable Master role, enable/disable data length extension, enable/disable 2Mbps/Coded PHY and extended advertising, scanning, enable/disable L2CAP-COS and enable/disable LE power control . For information about the supported Bluetooth LE stack v3.x modular configuration options and how to enable them, refer to the <a href="../BlueNRG-LP_aci_events/stack__user__cfg_8h.html">Bluetooth LE stack modular configuration options file </a>. </li>
<li>
Default Bluetooth LE stack v3.x modular configuration option is BLE_STACK_BASIC_CONF: controller privacy, LE secure connections, Master role, data length extension, 2Mbps/Coded PHY, extended advertising/scanning and l2CAP-COS features all disabled. </li>
</ul>
</li>
</ul>
<ul>
<li>Once the proper application configuration options have been identified, user can adapt/port a BlueNRG-LP/BlueNRG-LPS SDK test or demonstration application for building and running on a custom PCB following these steps: <ol>
<li>
Open the selected SW environment (IDE) and the related application project </li>
<li>
From the original project configuration, create a new project configuration for specific custom PCB (i.e. call it as: User_PCB) </li>
<li>
On the new User_PCB project configuration, add the previously described application configuration preprocessor options for selected High speed crystal and Low speed crystal sources, SMPS configuration, HSE tune. </li>
<li>
On the new User_PCB project configuration, add the proper Bluetooth LE stack v3.x modular configuration option. </li>
<li>
On Drivers/BSP folder create a new platform folder with configuration file (i.e steval_idb01xV1_config.h), Define related preprocesor option (i.e. STEVAL_IDB011V1 or STEVAL_IDB012V1) to be used on user project with associated header files path. </li>
<li>
Perform all other required customization for properly support the custom PCB HW resources (i.e. add support for specific custom PCB sensors, ...) </li>
<li>
Build, download and run the binay application on custom PCB and play with it! </li>
</ol>
</li>
</ul>
<ul>
<li>NOTEs: During application debugging/testing it is recommended to follow the <a href="../BlueNRG-LP_Debugging_Guidelines/BlueNRG-LP_Debugging_Guidelines.html">BlueNRG-LP, BlueNRG-LPS Bluetooth LE application debugging tips</a>.</li>
</ul>
<h2><a class="anchor" id="S4_1_2"></a>
How to move a demo application project from BlueNRG-355xy to BlueNRG-345xy</h2>
<ul>
<li>STSW-BNRGLP-DK, BlueNRG-LP/BlueNRG-LPS Development Kit (DK) SW package demonstrations applications target the BlueNRG-355xy device (Flash: 256 Kb; RAM: 64 Kb). </li>
<li>User can simply migrate a demo application from BlueNRG-355xy to BlueNRG-345xy (Flash: 256 Kb; RAM: 32 Kb) by adding the CONFIG_DEVICE_BLUENRG_345 as compiler and linker preprocessor options. </li>
<li>IAR toolchain: <ul>
<li>
On Projects, Options, General Options, Target select ST BlueNRG-345 </li>
<li>
On Projects, Options, C/C++ Compiler Preprocessor, Defined Symbols, add: CONFIG_DEVICE_BLUENRG_345 </li>
<li>
On Projects, Linker, Config, Configuration File symbols definition, add: CONFIG_DEVICE_BLUENRG_345=1 </li>
</ul>
</li>
<li>KEIL toolchain: <ul>
<li>
On Projects, Options for Target '...', Device, ST BlueNRG-LP Series, ST BlueNRG-LP select ST BlueNRG-345 </li>
<li>
On Projects, Options for Target '...', C/C++, Preprocessor Symbols, Define, add: CONFIG_DEVICE_BLUENRG_345 </li>
<li>
On Projects, Options for Target '...', Linker, Misc Control add: &ndash;predefine="-DCONFIG_DEVICE_BLUENRG_345=1" </li>
</ul>
</li>
<li>WiSE-Studio toolchain: <ul>
<li>
Open the WiSE-Studio .cproject file and replace BlueNRG-355 with BlueNRG-345 </li>
<li>
On Projects, Properties, C/C++ Build, Settings, Tool Settings, GCC C Compiler, Preprocessor, Defined Symbols, add: CONFIG_DEVICE_BLUENRG_345 </li>
<li>
On Projects, Properties, C/C++ Build, Settings, Tool Settings, GCC Linker, Miscellaneous, Other linker flags, add: -Wl,&ndash;defsym=CONFIG_DEVICE_BLUENRG_345=1 </li>
</ul>
</li>
</ul>
<ul>
<li>NOTE: <ul>
<li>
When moving to <b>BlueNRG-LP, BlueNRG-345xy, DTM application must be tuned </b>in order to fit within the 32 Kb RAM memory layout: <ul>
<li>
User should select the BLE stack modular option he needs for his specific application scenario. </li>
<li>
User should customize the DTM_Config.h parameters which affect RAM memory footprint based on his specific application scenario (number of links, max ATT_MTU size, number of attibutes, ....). </li>
<li>
DTM_Updater project must be also moved to BlueNRG-345xy </li>
</ul>
</li>
<li>
For evaluation purposes, a possible configuration option for BlueNRG-345xy DTM application is as follow (IAR project example is reported): <ul>
<li>
On Projects, Options, C/C++ Compiler Preprocessor, Defined Symbols, set: CONFIG_NUM_MAX_LINKS=3 </li>
<li>
On Projects, Options, C/C++ Compiler Preprocessor, Defined Symbols, replace BLE_STACK_FULL_CONF with BLE_STACK_CUSTOM_CONF: <ul>
<li>
Open the header file custom_ble_stack_config.h and set #define L2CAP_COS_ENABLED (0U). </li>
<li>
NOTE: CONTROLLER_CTE_ENABLED must be set to 0 since CTE is not supported on BlueNRG-345 device.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="S4_1_3"></a>
BlueNRG-LPS, DTM application configuration</h2>
<ul>
<li><b>BlueNRG-LPS, DTM application must be tuned in order to fit within the 192 Kb Flash and 32 Kb RAM memory layout</b>: <ul>
<li>
User should select the BLE stack modular option he needs for his specific application scenario in order to optimize Flash/RAM memory footprints. </li>
<li>
User should customize the DTM_Config.h parameters which affect RAM memory footprint based on his specific application scenario (number of links, max ATT_MTU size, number of attibutes, ....). </li>
<li>
On BlueNRG-LP_LPS SDK, the BlueNRG-LPS, DTM project is configured as follows only for evaluation purposes (using the STSW-BNRGUI, BlueNRG GUI and related scripts) : <ul>
<li>
<b>Flash optimization</b>: <ul>
<li>
Modular configurations L2CAP_COS_ENABLED and CONTROLLER_POWER_CONTROL_ENABLED are disabled (refer to BLE_STACK_CUSTOM_CONF option and associated modular configuration header file custom_ble_stack_conf.h). </li>
<li>
CONFIG_NO_HCI_COMMANDS preprocessor option is added for excluding HCI commands. </li>
<li>
BlueNRG-LPS DTM_Updater Flash size is 4Kb.</li>
</ul>
</li>
<li>
<b>RAM optimization</b>: <ul>
<li>
CONFIG_NUM_MAX_LINKS=3 (DTM UART project configurations preprocessor option) </li>
<li>
CONFIG_NUM_MAX_LINKS=3 (DTM SPI project configurations preprocessor option) </li>
<li>
NUM_ADV_SETS_CONF=2 (DTM project preprocessor option) </li>
<li>
DTM_Config.h configuration options: <ul>
<li>
NUM_LINKS = 3 </li>
<li>
DTM_NUM_GATT_ATTRIBUTES_CONF = 60 </li>
<li>
NUM_AUX_SCAN_SLOTS_CONF = 1 </li>
<li>
WHITE_LIST_SIZE_LOG2_CONF = 3 </li>
<li>
MAX_ATT_MTU_CONF = 160 </li>
<li>
ACI_ATT_QUEUED_WRITE_SIZE_CONF = 300 </li>
<li>
ACI_GATT_WR_BUFFER_SIZE_CONF = 1000 + ACI_ATT_QUEUED_WRITE_SIZE_CONF </li>
<li>
NUM_OF_CONCURRENT_GATT_CLIENT_PROC_CONF = CONFIG_NUM_MAX_LINKS </li>
<li>
WHITE_LIST_SIZE_LOG2_CONF = 3 </li>
<li>
L2CAP_MPS_CONF = 160 </li>
<li>
OPT_MBLOCKS_CONF =0 </li>
<li>
MAX_NUM_CTE_ANTENNA_IDS=8 (BlueNRG-LPS direction finding feature) </li>
<li>
MAX_NUM_CTE_IQ_SAMPLES=82U (BlueNRG-LPS direction finding feature) </li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
NOTE: <ul>
<li>
On BlueNRG-LP, BlueNRG-LPS SDK, the BlueNRG-LPS, DTM project configurations and related DTM_Config.h settings are defined only for evaluation purposes in order to demonstrate several Bluetooth LE stack v3.1x or later features. On real application scenario, DTM application configurations must be properly defined: user should turn on only the needed Bluetooth LE modular configurations on associated custom_ble_stack_conf.h file, and modify the DTM_Config.h values for fitting application requirements according to actual memory availability. </li>
</ul>
</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="S4_1_4"></a>
KEIL, MDK-ARM ARM Compiler version 6 support</h2>
<ul>
<li>STSW-BNRGLP-DK, BlueNRG-LP/BlueNRG-LPS Development Kit (DK) SW package has been updated in order to support KEIL, MDK-ARM ARM Compiler version 6. </li>
<li>As consequence, KEIL, MDK-ARM IDE demonstration applications projects have been updated from ARM Compiler 5 to ARM Compiler 6 as follow: <ul>
<li>
Projects menu, Options for Target 'user target'...: Target tab: <ul>
<li>
ARM Generation Code Compiler: Use default complier version 6 </li>
</ul>
</li>
<li>
Projects menu, Options for Target 'user target'...: C/C++ (AC6) tab:<ul>
<li>
Optimization: -Oz image size </li>
<li>
Warnings: AC5-like Warnings </li>
<li>
Short enum char </li>
<li>
Language C: c99 </li>
</ul>
</li>
<li>
Projects menu, Options for Target 'user target'...:Asm tab: <ul>
<li>
Assembler Option: armclang (Arm Syntax) </li>
<li>
Misc Controls: -x assembler-with-cpp </li>
<li>
Assembler control string: <ul>
<li>
&ndash;target=arm-arm-none-eabi -mcpu=cortex-m0plus -masm=armasm -c </li>
<li>
-gdwarf-3 -x assembler-with-cpp </li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>The BlueNRG-LP, BlueNRG-LPS KEIL, MDK-ARM linker files have been updated as follow: <ul>
<li>
Replaced ! armcc -E with: !armclang -E &ndash;target=arm-arm-none-eabi -mcpu=cortex-m0plus -xc </li>
<li>
Added .bss to .bss.ram_vr and .bss.crash_info_ram_vr </li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="S4_1_5"></a>
WiSE-Studio projects migrations steps from version 1.0.0 to version 1.1.0</h2>
<ul>
<li>WiSE-Studio projects built with WiSE-Studio v1.0.0 must be updated in order to be used with new WiSE-Studio v1.1.0 as follow: <ul>
<li>
Open with a text editor the ".cproject" file to be migrated to WiSE-Studio v1.1.0 </li>
<li>
Replace any instance of "BlueNRG-332AE" with "BlueNRG-332AT". </li>
</ul>
</li>
</ul>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.10-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Copyright &copy; 2022 by STMicrolectronics. All rights reserved.<br>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.10
</small></address>
</body>
</html>
