<!-- HTML header for doxygen 1.8.10-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>BlueNRG-LP/BlueNRG-LPS Bluetooth Low Energy Stack: BlueNRG-BLE Stack Library v_3_1a (04-April-2022)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="STcustom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ST-logo-small.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BlueNRG-LP/BlueNRG-LPS Bluetooth Low Energy Stack
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">BlueNRG-BLE Stack Library v_3_1a (04-April-2022) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="S1"></a>
Bluetooth Low Energy (LE) stack binary image files</h1>
<p>This section lists the Bluetooth LE Stack Library binary file to be used for the BlueNRG-LP/BlueNRG-LPS Systems On Chip configuration: <br />
</p>
<ul>
<li>libbluenrglp_stack.a binary library <b>v3.1a</b> with following main features: <ul>
<li>
Bluetooth LE 5.x specifications </li>
<li>
Direction Findings (AoA, AoD) [supported only on BlueNRG-LPS device] </li>
<li>
LE Data Packet Length Extension </li>
<li>
LE Secure Connections </li>
<li>
Link Layer Privacy </li>
<li>
2Mbps PHY </li>
<li>
LE Long Range (Coded PHY) </li>
<li>
High Duty Cycle Non-Connectable Advertising </li>
<li>
Extended advertising and scanning </li>
<li>
LE Channel Selection Algorithm #2 </li>
<li>
GATT Robust Caching </li>
<li>
Periodic Advertising and Periodic Advertising Sync Transfer </li>
<li>
LE Ping procedure </li>
<li>
LE L2CAP Connection-Oriented Channel support </li>
<li>
LE Power Control &amp; Path Loss Monitoring support </li>
<li>
Connection robustness mechanism: <ul>
<li>
It allows to tolerate delayed execution of Radio ISR by skipping connection events but not dropping the connection.</li>
</ul>
</li>
<li>
Multiple/concurrent active links supported (tested up to 24) </li>
<li>
Link statistics </li>
<li>
New GATT layer framework and updated commands/events interface: <ul>
<li>
It allows to handle GATT attributes values directly into user application, leaving to the Bluetooth LE library the ownership of data-transfer only.</li>
</ul>
</li>
<li>
New GAP layer APIs for advertising, scanning and connection procedures </li>
<li>
Support and integration of the new Timer module external to Bluetooth LE Library </li>
<li>
Support and integration of the new NVM module external to to Bluetooth LE Library </li>
<li>
ATT Maximum Transmission Unit (MTU) size is 1020 octets. </li>
<li>
L2CAP Maximum Payload Size (MPS) size is 1024 octets. </li>
<li>
MISRA-C:2012 compliance </li>
<li>
Bluetooth LE stack modular configurations allowing to optimize Bluetooth LE stack memory footprints based on user application scenario. <ul>
<li>
<b> Added new modular configuration option (CONNECTION_ENABLED) for allowing to enable/disable the connection capability </b>: <ul>
<li>
If connection option is disabled, connections are not supported; device is a broadcaster only if master capability option is disabled, or a broadcaster and observer only if master capability option is enabled. </li>
<li>
If connection option is enabled, connections are supported; device can only act as broadcaster or peripheral if master capability option is disabled, or any role (broadcaster, observer, peripheral, and central) if master capability option is enabled. </li>
</ul>
</li>
<li>
This option allows to improve Bluetooth LE FLASH memory footprint for applications scenarios not requesting connection capabilities.</li>
</ul>
</li>
</ul>
</li>
<li><b>NOTES</b>: <ul>
<li>
libbluenrg_lp_stack.a binary library file <b>v3.1a</b> is available in folder: <b>Middlewares\ST\Bluetooth_LE\Library</b>. The binary file must be linked to the built user application in order to get access to the Bluetooth LE stack features. </li>
<li>
libbluenrg_lp_stack.a is valid for the following supported toolchains: IAR-EWARM, ARM Keil MDK. </li>
<li>
When adding libbluenrg_lp_stack.a on a Keil project, just change the related File Type to Library File (from file Options). </li>
<li>
Configuration files stack_user_cfg.[c/h] are used for enabling the Bluetooth LE stack v3.x modular approach </li>
<li>
AES CMAC encryption functionality required by Bluetooth LE stack v3.x is available on new standalone binary library: Middlewares\ST\cryptolib\cryptolib.a </li>
<li>
Vendor Specific Error Codes values have been updated in order to align to new BLE Standard Error Codes added by BLE Specifications v.5.2: <ul>
<li>
All ST BlueNRG-BLE Stack Library v2.x error codes from value 0x40 have been shifted forward, starting from value 0x80. </li>
<li>
The new values are defined in the ble_status.h file </li>
</ul>
</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="S10"></a>
Bluetooth LE stack modular configurations options</h2>
<ul>
<li>Some predefined sets of <b>BlueNRG-BLE Stack Library</b> modular configurations options are available: <ol>
<li>
<b> BLE_STACK_FULL_CONF </b> &ndash;&gt; preprocessor option to be added on Bluetooth LE user application IDE toolchain, for configuring the Bluetooth LE stack with all supported modular features: <ul>
<li>
Controller Privacy is enabled </li>
<li>
LE Secure Connection is enabled </li>
<li>
Master role is enabled </li>
<li>
Data length extension is enabled </li>
<li>
LE 2M PHY, LE CODED PHY are enabled </li>
<li>
Extended Advertising is enabled </li>
<li>
LE L2CAP Connection-Oriented Channels is enabled </li>
<li>
Periodic advertising and sync transfer is enabled </li>
<li>
Constant Tone Extension is enabled (where applicable: not supported on BlueNRG-LP device) </li>
<li>
LE Power Control is enabled </li>
<li>
Connection capability is enabled</li>
</ul>
</li>
<li>
<b>BLE_STACK_BASIC_CONF</b> &ndash;&gt; preprocessor option to be added on Bluetooth LE user application IDE toolchain for configuring the Bluetooth LE stack with the basic configuration options: <ul>
<li>
Controller Privacy is disabled </li>
<li>
LE Secure Connection is disabled </li>
<li>
Master role is disabled (only Peripheral/Slave role is supported) </li>
<li>
Data length extension is disabled </li>
<li>
LE 2M PHY, LE CODED PHY are disabled </li>
<li>
Extended Advertising is disabled </li>
<li>
LE L2CAP Connection-Oriented Channels is disabled </li>
<li>
Periodic advertising and sync transfer is disabled </li>
<li>
Constant Tone Extension is disabled </li>
<li>
LE Power Control is disabled </li>
<li>
Connection capability is enabled</li>
</ul>
</li>
<li>
<b>BLE_STACK_SLAVE_DLE_CONF </b> &ndash;&gt; preprocessor option to be added on Bluetooth LE user application IDE toolchain for selecting the OTA Service support with Data length extension: <ul>
<li>
Controller Privacy is disabled </li>
<li>
LE Secure Connections is disabled </li>
<li>
Master role is disabled (only Peripheral/Slave role is supported) </li>
<li>
Data length extension is enabled </li>
<li>
LE 2M PHY and LE CODED PHY are disabled </li>
<li>
Extended Advertising is disabled </li>
<li>
LE L2CAP Connection-Oriented Channels is disabled </li>
<li>
Periodic advertising and sync transfer is disabled </li>
<li>
Constant Tone Extension is disabled </li>
<li>
LE Power Control is disabled </li>
<li>
Connection capability is enabled</li>
</ul>
</li>
</ol>
</li>
<li>NOTES: <ul>
<li>
Files stack_user_cfg.[c/h] must not be modified by user. </li>
<li>
<b>BLE_STACK_CUSTOM_CONF</b> option is also available for allowing user to define specific set of Bluetooth LE modular configuration options on a dedicated header file:<ul>
<li>
"custom_ble_stack_conf.h" to be placed on user demonstration application Inc folder. This allows user to select only the Bluetooth LE features required for the specific application scenario, and to optimize the application memory footprints.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="S11"></a>
Bluetooth Low Energy (LE) stack network coprocessor configuration</h1>
<ul>
<li>The following network coprocessor modes are supported when using BlueNRG GUI and DTM application: UART (mainly for RF evaluation purpose) and SPI. </li>
<li>DTM project and related workspaces provides reference applications for configuring the BlueNRG-LP/BlueNRG-LPS platforms as a network coprocessor (refer to BlueNRG-LP DK Release notes documentation for more information).</li>
</ul>
<h1><a class="anchor" id="S12"></a>
New Features</h1>
<p>This section lists the new features compared to previous Bluetooth LE Stack Library<br />
</p>
<ul>
<li>Added support for new modular configuration option (CONNECTION_ENABLED) allowing to enable/disable the connection capability:<ul>
<li>
It allows to configure a device as broadcaster-only or as broadcaster-only + observer-only. </li>
</ul>
</li>
</ul>
<ul>
<li>NOTES: <ul>
<li>
Refer to <a href="../BlueNRG-LP_BLE_stacks_migration/index.html">Bluetooth LE Stack v2.x to v3.x migration guideline html documentation </a> for information about how to port an application from BLE stack v2.x to v3.x and later. </li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="S13"></a>
Solved Issues</h1>
<p>This section lists the solved issues compared to previous Bluetooth LE Stack Library</p>
<ul>
<li>ID 1022556: Remove the setting of the default antenna from the CTE related commands </li>
<li>ID 1005166: Add a specific error code for TX_ERROR_1 and TX_ERROR_3 </li>
<li>ID 982407: Memory allocation optimization when the MASTER feature is disabled </li>
<li>ID 964970: Set specific RF configuration for the TX test command on BlueNRG-LPS </li>
<li>ID 912860: Add check on availability of NumOfAuxScanSlots </li>
<li>ID 690038: ll_get_advertising_info update for Periodic Advertising support </li>
<li>ID 1003140: L2CAP formula to compute Credits for Flow Control Mode with Automatic High Throughput policy </li>
<li>ID 948515: Bluetooth SECURITY Notice: CVE-2020- 37577 (Impersonation in the Passkey Entry Protocol in LE-SC Pairing) </li>
<li>ID 1023038: Direct_Address_Type field of HCI_LE_Extended_Advertising_Report event sometime assumes invalid values </li>
<li>ID 1021798: Disconnection occurs if starts encryption request received just before data length update </li>
<li>ID 1021525: Device unresponsive after command HCI_LE_SET_RESOLVABLE_PRIVATE_ADDRESS_TIMEOUT with RPA_Timeout = 0 </li>
<li>ID 1021213: BLE stack v3.1x RADIO_STACK_SleepCheck returns POWER_SAVE_LEVEL_RUNNING after pairing </li>
<li>ID 1017881: Advertising_Data_Length in function aci_gap_set_periodic_advertising_data is uint8_t while it should be uint16_t </li>
<li>ID 1014413: HCI_LE_Set_Host_Channel_Classification command causes hard fault when connections are disabled by modularity </li>
<li>ID 1015269: Potential fault in per-statistic functions iif used when connections are disabled by modularity </li>
<li>ID 1015273: The periodic synchronizer doesn't get channel map updates from AUX_SYNC_IND PDUs </li>
<li>ID 1014018: Supervision Timeout range validity check not consistent with specification requirement </li>
<li>ID 1010649: Skipped periodic advertising events. </li>
<li>ID 1010750: Wrong Delta field value in HCI_LE_Transmit_Power_Reporting event when reason is 0x02. </li>
<li>ID 1001862: LE Legacy Pairing failure when peer Central declares LTK distribution only (bug 6942 of v.2.x) </li>
<li>ID 1001313: Disconnection with MIC failure in Peripheral when Encryption is rejected and Central acnkowledges the Reject with a LL Data or Control PDU </li>
<li>ID 994607: Gap advertising state not updated if a set terminates due to duration or number of events </li>
<li>ID 990070: L2CAP Connection Parameter Update response: unexpected reject </li>
<li>ID 984015: Pairing timeout with high Connection latency value </li>
<li>ID 984002: L2CAP COS Rx Credits automatically sent during LE Connection Request/Response may be greater than RX Buffer Size w.r.t. declared MTU/MPS values </li>
<li>ID 983397: Received corrupted data from L2C COS channel </li>
<li>ID 980028: First SDU segment with SDU Length field of 1 octet only is not specifically addressed by the L2C COS reassembly procedure </li>
<li>ID 978060: Missing HCI_ENCRYPTION_CHANGE_EVENT in PTS tests related to GAP/Security (when executed in automatic mode only) </li>
<li>ID 812783: In SoC mode, the GAP layer does not check whether the application is using an out-of-spec advertising data length </li>
<li>ID 915769: Memory leakage may happen after an exchange MTU configuration procedure </li>
<li>ID 987416: aci_hal_adv_scan_resp_data_update_event not generated </li>
<li>ID 986909: Unexpected HCI_HARDWARE_ERROR_EVENT during the auto connection procedure </li>
<li>ID 979541: Tx packet not freed/released when sending an LE-CFC Connection Request/Response but no Channel Descriptors are available </li>
<li>ID 975686: Wrong RSSI value in IQ reports </li>
<li>ID 969060: Scan slot not free after several General Discovery procedure </li>
<li>ID 963424: Pairing Timeout in case of Numeric Comparison on Central against a faster Peripheral device </li>
<li>ID 952967: Anonymous advertising is not working </li>
<li>ID 945766: No ADI field in AUX_CHAIN_IND packets of the scan response </li>
<li>ID 887596: PA synchronizer doesn't update channel classification </li>
<li>ID 871933: GAP advertising active flag not updated when a connection is created </li>
<li>ID 871174: Persistent Advertising after Connection </li>
<li>ID 856613: HardFault when a SCAN_RSP is received with length equal to 0. </li>
<li>ID 984614: Wrong supervision timeout during the early termination phase </li>
<li>ID 982297: Unexpected Connection Update Failure with disconnection </li>
<li>ID 974036: The HCI_LE_SET_EXTENDED_SCAN_ENABLE command returns Success even when the 'master' feature is disabled </li>
<li>ID 971782: L2CAP Disconnection request indicating wrong DCID is not rejected </li>
<li>ID 965124: unexpected HCI_LE_EXTENDED_ADVERTISING_REPORT_EVENT is received after the stop of scanning procedure </li>
<li>ID 963876: Advertising report not properly generated in case of scannable advertising </li>
<li>ID 953961: The advertising data ID in not randomly set </li>
<li>ID 953052: RPA not refreshed at timer expiration if address resolution is not enabled </li>
<li>ID 952599: No sync lost event generated if window widening exceeds interval/2 </li>
<li>ID 948430: Collision between different advertising trains is not detected by extended scanner </li>
<li>ID 898693: In case of chained scan response, AdvMode field of AUX_SCAN_RSP and AUX_CHAIN_IND is not set to zero </li>
<li>ID 870159: Coding error in function related to periodic advertising </li>
<li>ID 704010: No LL_REJECT_IND transmitted if HCI_LE_Long_Term_Key_Request masked </li>
<li>ID 699601: No rejection of LL_PAUSE_ENC_REQ or LL_PING_REQ on link unencrypted </li>
<li>ID 699567: No close connection when receiving LL_PAUSE_ENC_REQ after LL_ENC_REQ pdu </li>
<li>ID 616373: Multiple connections are allowed between the same 2 devices </li>
<li>ID 580833: No error is given if number of Link Layer state machines is not sufficient</li>
</ul>
<h1><a class="anchor" id="S14"></a>
Limitations/Bugs</h1>
<p>This section lists the issues known at firmware image release time. Issues found after this release are listed as solved or limitations on newer releases. <br />
</p>
<ul>
<li>ID 600131: HCI timeout on ACI_GAP_CLEAR_SECURITY_DB command: <ul>
<li>
Erasing the SDB through the aci_gap_clear_security_db command shall be avoided during intense radio activities (meaning also when a connection is active). </li>
</ul>
</li>
<li>ID 603240: Extended/legacy advertising usage check (workaround exists: do not use API HCI_LE_SET_ADVERTISING_PARAMETERS) </li>
<li>ID 611316: No error returned if the ACI_GAP_SET_SCAN_CONFIGURATION command is issued with LE_Scan_Window &gt; LE_Scan_Interval (an "invalid configuration" error is returned once the Scan procedure is started). </li>
<li>ID 685513: Same error code should be returned by GAP and HCI in case of wrong input parameter </li>
<li>ID 694231: Wrong Command Status in for HCI_LE_CONNECTION_UPDATE if device in Slave Role </li>
<li>ID 974202: Wrong data reported when ExtendedHeaderLength are less than rigth value </li>
<li>ID 987581: HCI timeout error after HCI_LE_START_ENCRYPTION (only for MINIMAL cfg).</li>
</ul>
<h1><a class="anchor" id="S15"></a>
Documentation</h1>
<ul>
<li>Refer to <a href="../BlueNRG-LP_aci_events/files.html">Bluetooth Low Energy (LE) API and events html documentation </a> for detailed description of Bluetooth LE stack APIs and related events callbacks. </li>
<li>Refer to <a href="../BlueNRG-LP_BLE_stacks_migration/index.html">Bluetooth LE stack migration guidelines from v2.x to v3.x html documentation </a> for guidelines about how to migrate applications from Bluetooth low energy stack v2.x to v3.x.</li>
</ul>
<h1><a class="anchor" id="S16"></a>
BLE stack Flash memory footprints (bytes)</h1>
<ul>
<li><b>BLE stack full Flash size (all APIs and events used)</b></li>
</ul>
<table  border="1">
<tr>
<th>Stack version </th><th>Full Stack Size  </th></tr>
<tr>
<td><b> V3.0 </b> </td><td>124.11 Kb  </td></tr>
<tr>
<td><b> V3.1 </b> </td><td>144.9 Kb  </td></tr>
<tr>
<td><b> V3.1a </b> </td><td>144.8 Kb   </td></tr>
</table>
<ul>
<li><b>BLE Sensor Demo application (BlueNRG-LP case): only BLE stack components Flash size </b></li>
</ul>
<table  border="1">
<tr>
<th>Stack version </th><th>Release </th><th>LowerApp_OTA </th><th>HigherApp_OTA </th><th>Use_OTA_ServiceManager </th></tr>
<tr>
<td><b> V3.0</b> </td><td>62.2 Kb (1) </td><td>64.08 Kb (2) </td><td>64.08 Kb (2) </td><td>62.2 Kb (1) </td></tr>
<tr>
<td><b> V3.1</b> </td><td>62.4 Kb (1) </td><td>64.10 Kb (2) </td><td>64.10 Kb (2) </td><td>62.2 Kb (1) </td></tr>
<tr>
<td><b> V3.1a </b> </td><td>61.7 Kb (1) </td><td>63.4 Kb (2) </td><td>63.4 Kb (2) </td><td>61.7 Kb (1)  </td></tr>
</table>
<ul>
<li><b> NOTES</b>: <ol>
<li>
BASIC stack configuration </li>
<li>
BASIC stack + extended data length configuration </li>
</ol>
</li>
</ul>
<ul>
<li><b>BLE Beacon application (BlueNRG-LP case): only BLE stack components Flash size </b></li>
</ul>
<table  border="1">
<tr>
<th>Stack version </th><th>Release </th></tr>
<tr>
<td><b> V3.0 (BASIC stack Configuration) </b> </td><td>62.12 Kb (1) </td></tr>
<tr>
<td><b> V3.1 (BASIC stack Configuration) </b> </td><td>62.17 Kb (1) </td></tr>
<tr>
<td><b> V3.1a (CUSTOM stack Configuration) </b> </td><td>16.09 Kb (2)  </td></tr>
</table>
<ul>
<li><b> NOTES</b>: <ol>
<li>
On Bluetooth LE stack V3.0 and V3.1 BASIC stack configuration is used: connection capability is enabled by default and it cannot be turned OFF. </li>
<li>
On Bluetooth LE stack V3.1a, CUSTOM stack configuration allows to set new CONNECTION_ENABLED option to 0 (connection capability is turned OFF). </li>
</ol>
</li>
</ul>
<ul>
<li><b> OTA Service Manager: total application Flash size </b></li>
</ul>
<table  border="1">
<tr>
<th>Stack version/(device) </th><th>BASIC stack + extended data length configuration </th></tr>
<tr>
<td><b> V3.0 (BlueNRG-LP) </b> </td><td>90 Kb </td></tr>
<tr>
<td><b> V3.1 (BlueNRG-LP) </b> </td><td>94 Kb </td></tr>
<tr>
<td><b> V3.1a (BlueNRG-LP/BlueNRG-LPS)</b> </td><td>94 Kb  </td></tr>
</table>
<h1><a class="anchor" id="S164"></a>
BLE Throughput</h1>
<table  border="1">
<tr>
<th>Stack version </th><th>Unidirectional (ATT_MTU size = 23; no Data Length Extension) </th><th>Bidirectional (ATT_MTU size = 23; no Data Length Extension)  </th><th>Unidirectional (ATT_MTU size = 247; Data Length Extension = 251 on Peripheral side)  </th><th>Bidirectional (ATT_MTU size = 247; Data Length Extension = 251 on both Peripheral and Central sides) </th></tr>
<tr>
<td><b> 1Mbps PHY </b> </td><td>~220 kbps </td><td>~166 kbps  </td><td>~740 kbps  </td><td>~390 kbps  </td></tr>
<tr>
<td><b> 2Mbps PHY </b> </td><td>~317 kbps </td><td>~260 kbps  </td><td>~1367 kbps  </td><td>~783 kbps   </td></tr>
</table>
<ul>
<li><b> NOTES</b>: <ul>
<li>
Unidirectional: GAP Peripheral performs characteristic notification to GAP Central. </li>
<li>
Bidirectional: GAP Peripheral performs characteristic notification to GAP Central and GAP Central performs characteristic write without response to GAP Peripheral. </li>
</ul>
</li>
</ul>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.10-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Copyright &copy; 2022 by STMicrolectronics. All rights reserved.<br>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.10
</small></address>
</body>
</html>
