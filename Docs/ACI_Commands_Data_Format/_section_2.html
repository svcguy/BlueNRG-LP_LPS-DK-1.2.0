<!-- HTML header for doxygen 1.8.10-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>BlueNRG-LP network coprocessor: Bluetooth LE stack v3.x ACI commands data format</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="STcustom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ST-logo-small.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BlueNRG-LP network coprocessor
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Bluetooth LE stack v3.x ACI commands data format </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="S2_1"></a>
Bluetooth LE stack v3.x ACI commands types</h1>
<ul>
<li>The Bluetooth LE stack v3.x ACI commands utilize and extend the standard HCI data format. </li>
<li>According to the Bluetooth specification, a standard HCI packet can be an: <ul>
<li>
HCI command packet (packet type: 0x01) </li>
<li>
HCI ACL data packet (packet type: 0x02) </li>
<li>
HCI synchronous data packet (packet type: 0x03) </li>
<li>
HCI event packet (packet type: 0x04) </li>
<li>
HCI extended command (packet type: 0x81) </li>
<li>
HCI extended event (packet type: 0x82)</li>
</ul>
</li>
</ul>
<ul>
<li>In the Bluetooth LE stack v3.x, the HCI synchronous data packet is not supported, but the other three are.</li>
</ul>
<h2><a class="anchor" id="S2_1_1"></a>
HCI command packet format</h2>
<ul>
<li>When an external device gives a command to the Bluetooth LE stack v3.x, the command must be formatted in a HCI command packet. </li>
<li>The Bluetooth LE stack v3.x only receives the HCI command packets, but does not transmit.</li>
</ul>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="HCi_Command_packet.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 1: HCI command packet </b>  </td></tr>
</table>
<ul>
<li>Each HCI command uses a 2 byte OpCode to uniquely identify different types of commands. </li>
<li>The OpCode is divided into two fields: the OpCode Group Field (OGF) and the OpCode Command Field (OCF): <ul>
<li>
The OGF is the upper 6 bits and the remaining lower 10 bits are used by the OCF.</li>
</ul>
</li>
<li>All HCI commands are grouped into logical groups by the Bluetooth specification and each group is assigned a unique OGF value.</li>
</ul>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="TABLE_OGF.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 2: OGF value </b>  </td></tr>
</table>
<ul>
<li>Depending on the OGF, the commands can be categorized into 3 sets: <ol>
<li>
Standard HCI commands: the commands with an OGF value other than 0x3F. These commands are designed for the controller. All standard HCI command are clearly defined in the Bluetooth specification. </li>
<li>
Vendor specific (VS) HCI commands: the commands with an OGF value 0x3F and are designed for the controller. Each vendor can define their own VS commands based on the hardware implementation. </li>
<li>
Vendor specific (VS) ACI commands: the commands also with an OGF value 0x3F, but these commands are designed to control/access the host. The Bluetooth specification does not define any command for the host, so all the ACI commands are naturally vendor specific. </li>
</ol>
</li>
<li>To clarify, the commands designed to control the controller are called HCI commands. This name is defined by the Bluetooth specification and we maintain it here in order to comply with the specification. </li>
<li>The commands designed to control the host are called ACI commands. We give it a different name to indicate that this command is rather assigned to the host, i.e. to the whole Bluetooth LE system, and not only to the controller at the lower level. However, because both ACI and HCI commands are the commands received from the external device via the ACI interface, and both of them share the same data format, sometimes it is not very important to differentiate between the two. </li>
<li>In practice, the value of the OpCode is more important. Each command, regardless of whether it is an HCI or an ACI command, matches only one OpCode value. The user application should guarantee the OpCode value is used correctly. </li>
<li>NOTE: The Bluetooth specification uses bit-wise little endian format for the OpCode. So in Figure 1. HCI command packet, the OGF field is placed to the right. In this document, when writing an OpCode in the format of 0xXXXX, we imply the most significant bit to the left. For example, if an OpCode is 0xFE81, its top 6-bit OGF is "111111", i.e. 0x3F, so it is a vendor specific command. And its OCF is 10-bit 0x281. For another example, if an OpCode is 0x0406, the 6-bit OGF is 0x01, and its OCF is 0x06. So this is a standard HCI command, HCI_Disconnect.</li>
</ul>
<h2><a class="anchor" id="S2_1_2"></a>
HCI event packet</h2>
<ul>
<li>The Bluetooth LE stack v3.x uses event packets to acknowledge a command or to notify that its status has updated to the user application. The Bluetooth LE stack v3.x only sends HCI event packets, but does not receive them.</li>
</ul>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="HCi_Event_packet.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 3: HCI Event packet </b>  </td></tr>
</table>
<h2><a class="anchor" id="S2_1_3"></a>
HCI ACL data packet</h2>
<ul>
<li>The ACL data packets are used to exchange data.</li>
</ul>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="HCi_ACL_packet.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 4: HCI ACL data packet </b>  </td></tr>
</table>
<h2><a class="anchor" id="S2_1_4"></a>
HCI extended command packet format</h2>
<ul>
<li>The Bluetooth LE stack v3.x HCI extended command packet format is same as HCI extended command packet with the total length field parameter size of 2 bytes.</li>
</ul>
<h2><a class="anchor" id="S2_1_5"></a>
HCI extended event packet</h2>
<ul>
<li>The Bluetooth LE stack v3.x HCI extended event packet format is same as HCI extended event packet with the total length field parameter size of 2 bytes.</li>
</ul>
<h2><a class="anchor" id="S2_1_6"></a>
Vendor specific (VS) commands</h2>
<ul>
<li>The Vendor specific commands can be either ACI VS commands to access the host of the Bluetooth LE stack v3.x, or the HCI VS commands to access the LE controller. Both types of the commands use the OGF value of 0x3F. </li>
<li>The OCF field of the OpCode of the VS commands is further divided into two fields: Command Group ID and Command ID.</li>
</ul>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="OpCode.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 5: OpCode format for VS commands </b>  </td></tr>
</table>
<ul>
<li>Figure 5. OpCode format for VS commands above gives the 16-bit OpCode format (see also Section HCI command packet). </li>
<li>The OGF field is always 0x3F for VS commands. The 10-bit OCF field is split into two parts:<ul>
<li>
3-bit Command Group ID (CGID) </li>
<li>
7-bit Command ID (CID). </li>
</ul>
</li>
<li>The CGID is used by the Bluetooth LE stack v3.x ACI interface to route the commands to different logical layers, e.g. L2CAP, GAP, GATT, etc. It also helps to categorize the VS commands with a more clear structure. The CID determines the ID of each command. Each CGID group can have up to 128 VS commands. <table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="TABLE_CGID.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 6: CGID group </b>  </td></tr>
</table>
</li>
</ul>
<ul>
<li>The VS event also has a slightly different format than the standard HCI event (see also Section HCI event packet): <ul>
<li>
The 8-bit event code of the VS event always has the value of 0xFF. </li>
<li>
The 16-bit event parameter 0 has a different format. </li>
</ul>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="TABLE_event.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 7: Event parameter 0 format for VS events </b>  </td></tr>
</table>
</li>
</ul>
<ul>
<li>The event parameter 0 is the first return parameter in the HCI event packets, following the Parameter Length field. </li>
<li>These 2 bytes together are defined as the Bluetooth LE stack v3.x Event Code (ECODE). ECODE is further divided into 2 fields: <ul>
<li>
Event Group ID (EGIO) </li>
<li>
Event ID (EID) </li>
</ul>
</li>
<li>Bluetooth LE stack v3.x combines the events into logical groups using the EGID. And the EID is used to specify an event in the group. The EGID occupies 6-bits in the ECODE field while the EID occupies the remaining 10 bits.</li>
</ul>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="TABLE_EGID.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 8: EGID group </b>  </td></tr>
</table>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.10-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Copyright &copy; 2022 by STMicrolectronics. All rights reserved.<br>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.10
</small></address>
</body>
</html>
