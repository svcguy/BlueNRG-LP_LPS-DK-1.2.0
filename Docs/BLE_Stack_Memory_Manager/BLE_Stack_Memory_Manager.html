<!-- HTML header for doxygen 1.8.10-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>BlueNRG-LP Bluetooth LE stack v3.x: Stack Memory Management</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="STcustom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ST-logo-small.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BlueNRG-LP Bluetooth LE stack v3.x
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Stack Memory Management </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The present document guidelines are intended to help users of the Bluetooth Low Energy (LE) Stack Library to properly set the Packets Memory Management parameters according to the specific application profiles that the target application is going to implement. <br />
 This document is valid for BlueNRG-LP/BlueNRG-LPS Bluetooth LE stack v3.x.</p>
<h1><a class="anchor" id="P1"></a>
Packet Manager</h1>
<ul>
<li>Bluetooth Low Energy stack library v3.x supports the Fragmentation and Recombination of L2CAP PDUs. </li>
<li>Fragmentation consists in splitting large PDUs into multiple small fragments, so that each one can be sent in a single link layer packet. Recombination is reassembling these fragments in a single L2CAP PDU. <table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="Figure_1.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 1: Host Packets plitting </b>  </td></tr>
</table>
</li>
<li>This feature allows to exchange larger ATT packets among Bluetooth LE nodes for addressing the needs to carry out more data, for instance to write more data with a single write request. While a connected peer device can handle larger ATT MTU, another one could not. To support Fragmentation and Recombination in this heterogeneous scenario with different peer's characteristics, a new module has been added for handling the memory resources. This module, namely Packet Manager (PM), handles the memory allocated for packets in order to control system performance and reducing memory footprint: the user application can control the allocated resources based on its application scenario. </li>
<li>The scope of this document is to underline the key features of Packet Manager module allowing to get the requested performances</li>
</ul>
<h1><a class="anchor" id="P2"></a>
Memory buffer allocation size</h1>
<ul>
<li>The BLE_STACK_TOTAL_BUFFER_SIZE macro is used to compute the amount of heap memory to be allocated for the stack library. </li>
<li>The MBLOCKS_COUNT parameter is used to tune the allocated memory for the Packet Manager. This value has to be computed taking into account different key points: <ul>
<li>
Mandatory: <ul>
<li>
Maximum supported ATT_MTU. </li>
<li>
Maximum number of simultaneous connections that the device will support. </li>
</ul>
</li>
<li>
Optional: <ul>
<li>
Speed-up Throughput (OPT_MBLOCKS_CONF parameter); </li>
<li>
OPT_MBLOCKS_CONF is an optional number of blocks that should be given to the stack to increase the number of buffers. In some cases, increasing the number of buffers can help the application increase the throughput. </li>
</ul>
</li>
</ul>
</li>
<li>The BLE_STACK_MBLOCKS_CALC macro is provided to compute the mandatory memory size required for the basic stack functionality, while the optional packets can be freely set on the basis of application profile requirement.</li>
</ul>
<h1><a class="anchor" id="P3"></a>
ATT MTU</h1>
<ul>
<li>ATT Maximum Transmission Unit (MTU) is the maximum length of an ATT packet. The ATT MTU is defined by the L2CAP and it can be between 23 (default) and 65535 bytes (ST Bluetooth LE stack 3.x supports an ATT MTU up to 1020 bytes). </li>
<li>When using larger ATT MTU, the application packets are fragmented into 27-byte Link Layer packets and then the throughput can increase as we eliminate transferring ATT and L2CAP layers overhead bytes and replacing them with ATT data.</li>
</ul>
<h1><a class="anchor" id="P4"></a>
Optional resources</h1>
<ul>
<li>The packet resources can be requested to satisfy user application and remote requests: <ul>
<li>
If the user application wants to execute an operation that requires to send a packet, the PM tries to allocate the requested fragments. If the resources are not available it fails and an "insufficient resources" error is returned. The user application can retry when the resources become available. </li>
<li>
If the stack has to elaborate a request from a remote peer, it checks if there are the needed resources to elaborate it and to compose the response packet. If the resources are not available, the requested elaboration is postponed when the resource becomes available. </li>
</ul>
</li>
<li>For such reason, optional memory blocks can be allocated (using the OPT_MBLOCKS_CONF macro) to reduce the probability to get missing resources and then to speed-up the application throughput. </li>
</ul>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.10-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Copyright &copy; 2022 by STMicrolectronics. All rights reserved.<br>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.10
</small></address>
</body>
</html>
