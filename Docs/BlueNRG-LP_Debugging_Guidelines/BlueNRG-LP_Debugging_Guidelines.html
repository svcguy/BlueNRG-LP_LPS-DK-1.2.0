<!-- HTML header for doxygen 1.8.10-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>BlueNRG-LP/BlueNRG-LPS Bluetooth LE Applications: Debugging Tips &amp; Main Guidelines</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="STcustom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ST-logo-small.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BlueNRG-LP/BlueNRG-LPS Bluetooth LE Applications
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Debugging Tips &amp; Main Guidelines </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This document provides some useful debugging guidelines to be followed when debugging Bluetooth LE applications, programming Bluetooth LE applications using CMIS-DAP tool and how to use the crash handler utilities </p>
<h1><a class="anchor" id="U1"></a>
Debug a BlueNRG-LP/BlueNRG-LPS Bluetooth LE application</h1>
<h2><a class="anchor" id="U11"></a>
Debug vs Bluetooth LE radio operations</h2>
<ul>
<li>BlueNRG-LP/BlueNRG-LPS Bluetooth LE radio operations are driven by the radio timer ISR: <ul>
<li>
Every time the radio ISR is called, in order to maintain the synchronization with the connection event, the next timeout is programmed with the new value according the actual value. </li>
<li>
BlueNRG-LP/BlueNRG-LPS has a Bluetooth LE radio: if the execution is stopped for debug purpose, this will imply some delay on the radio ISR management which could lead to connection lost and bad radio behavior: <ul>
<li>
i.e.: if the application stops the code execution, the synchronization can’t be maintained and the connection can be lost; </li>
<li>
i.e.: if the application stops the code execution, in case of advertising a back to back communication can be started. </li>
</ul>
</li>
<li>
As consequence, <b> when debugging a Bluetooth LE application, please take in account that radio communication can be compromised and the connection can be lost </b></li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="U12"></a>
Debugging vs BlueNRG-LP/BlueNRG-LPS running application in low power modes</h2>
<ul>
<li>There are certain situations where debug access is disabled and the chip cannot be accessed, including: <ul>
<li>
application that disables SWD debug pins (SWDIO: PA2; SWCLK: PA3;) </li>
<li>
application that sets the device in DEEPSTOP mode (<em>HAL_PWR_MNGR_Request()</em> API configured with POWER_SAVE_LEVEL_STOP_NOTIMER or POWER_SAVE_LEVEL_STOP_WITH_TIMER), in which the debug port is not powered.</li>
</ul>
</li>
<li>These cases are common during application development and device can end up in a state where debug access is no longer possible.</li>
</ul>
<ul>
<li>To recover this situation, the following options are recommended: <ol>
<li>
Do not use the DEEPSTOP mode by changing call to <em>HAL_PWR_MNGR_Request()</em> as follow: <ul>
<li>
<em> HAL_PWR_MNGR_Request(<b>POWER_SAVE_LEVEL_CPU_HALT</b>, 0, 0); </em> <br />
 In this mode, CPU will never goes to DEEPSTOP and debug access is always granted. Application has to be modified and execution time may be different</li>
</ul>
</li>
<li>
Use a GPIO to wakeup the system and grant access to the debugger. User may need to change the call to <em>HAL_PWR_MNGR_Request</em> as follow:<ul>
<li>
<em> HAL_PWR_MNGR_Request(POWER_SAVE_LEVEL_STOP_NOTIMER, wakeupIO, &amp;stopLevel); </em> </li>
<li>
Where: <em> WakeupSourceConfig_TypeDef wakeupIO = {0, WAKEUP_PA8, 0, 0}; /* example of wakeup from PA8 */ </em> When debugger access is wanted, user should force the wakeup I/O (IO13 in the example) low and then use the “Attach to running target” in the debugger. </li>
</ul>
</li>
</ol>
</li>
</ul>
<h2><a class="anchor" id="U13"></a>
CMSIS-DAP programming vs BlueNRG-LP/BlueNRG-LPS running application in low power modes</h2>
<ul>
<li>When the BlueNRG-LP/BlueNRG-LPS device is in DEEPSTOP mode, the SWD port is disabled: <ul>
<li>
Put the PA10 pin high and then reset the BlueNRG-LP/BlueNRG-LPS device: UART bootloader is activated and user can program the selected application (with POWER_SAVE_LEVEL_CPU_HALT sleep mode parameter) <ul>
<li>
On BlueNRG-LP/STEVAL-IDB011V{1|2}, BlueNRG-LPS/STEVAL-IDB012V1 just keep pressed the button PUSH1 and then press the RESET button to put the device in UART bootloader mode. </li>
</ul>
</li>
<li>
Perform a mass erase of the device using the RF-Flasher Utility tool (which uses the BlueNRG-LP/BlueNRG-LPS UART bootloader) and then program the selected application (with POWER_SAVE_LEVEL_CPU_HALT sleep mode parameter) </li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="U2"></a>
BlueNRG-LP/BlueNRG-LPS Crash Handler utilities</h1>
<ul>
<li>Some crash handler utilities/structures are provided on BlueNRG-LP DK SW package framework: \Middlewares\ST\hal\Inc\crash_handler.h, Hal_miscutil.h files and \Middlewares\ST\hal\src\hal_miscutil.c file: <ul>
<li>
<em>crash_info_t</em> structure: it defines the overall crash information structure (stack pointer, program counter, registers, ...). </li>
<li>
<em>HAL_GetCrashInfo(&amp;crash_info)</em>: it allows to return the crash information that are stored in RAM, by hard handler, nmi handler and assert handler. </li>
<li>
<em>HAL_CrashHandler(msp,signature)</em> : it allows to store crash information in RAM and reset the device (crash information can be retrieved by using API <em>HAL_GetCrashInfo()</em> function).</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="U21"></a>
BlueNRG-LP/BlueNRG-LPS Crash Handler utilities: basic example</h2>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="Figure_1.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 1: BlueNRG-LP/BlueNRG-LPS crash handler basic example </b>  </td></tr>
</table>
<ul>
<li>Figure 1 shows the main application of a BlueNRG-LP/BlueNRG-LPS Bluetooth LE applicaton using the crash handler HAL utility <em>HAL_GetCrashInfo()</em> <ul>
<li>
<em>crash_info</em> variable defines the variable where crash info information are stored </li>
<li>
<em>HAL_GetCrashInfo(&amp;crash_info)</em> allows to get the crash information </li>
<li>
At reset, if an assert occurs, application will detect it (<em>if (crash_info.signature&amp;0xFFFF0000) == CRASH_SIGNATURE_BASE)</em>) </li>
<li>
By analyzing the crash_info data (registers, stack pointer, programm counter value), user can get some useful information in order to identify issue root cause.</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="U21"></a>
BlueNRG-LP/BlueNRG-LPS Crash Handler utilities: basic example</h2>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="Figure_2.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 2: BlueNRG-LP/BlueNRG-LPS NMI and Hard Fault handler information storage </b>  </td></tr>
</table>
<ul>
<li>Figure 2 shows the usage of the <em>HAL_CrashHandler()</em> utility function, in order to store NMI and Hard Fault exception crash information on related interrupt handlers: <ul>
<li>
<em> HAL_CrashHandler(__get_MSP(), NMI_SIGNATURE);</em> on BlueNRG-LP/BlueNRG-LPS <em>NMI_Handler()</em> irq handler; </li>
<li>
<em> HAL_CrashHandler(__get_MSP(), HARD_FAULT_SIGNATURE);</em> on BlueNRG-LP/BlueNRG-LPS <em>HardFault_Handler()</em> irq handler; </li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="U3"></a>
References</h1>
<ul>
<li>Refer to BlueNRG-LP Middlewares, HAL APIs doxygen documentation, crash_handler.h, hal_miscutil.h files for crash handler structures and APIs utilities details. </li>
</ul>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.10-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Copyright &copy; 2022 by STMicrolectronics. All rights reserved.<br>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.10
</small></address>
</body>
</html>
